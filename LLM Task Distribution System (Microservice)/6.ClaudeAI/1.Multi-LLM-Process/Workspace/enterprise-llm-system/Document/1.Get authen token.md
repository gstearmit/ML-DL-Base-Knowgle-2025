## Tôi sẽ giúp bạn triển khai Flow 1 (Request Initialization) để có thể test trên Postman. Đây là các file cần thiết:

1. API Gateway Controller:

````java:enterprise-llm-system/services/api-gateway/src/main/java/com/llm/gateway/controller/ApiController.java
@RestController
@RequestMapping("/api")
@Slf4j
public class ApiController {

    @Autowired
    private AuthenticationService authService;
    
    @Autowired
    private TaskManagerClient taskManagerClient;

    @PostMapping("/tasks")
    public ResponseEntity<TaskResponse> createTask(
            @RequestHeader("Authorization") String token,
            @RequestBody TaskRequest request) {
        
        log.info("Received task creation request");
        
        // Step 1: Validate token
        AuthResult authResult = authService.validateToken(token);
        if (!authResult.isValid()) {
            throw new UnauthorizedException("Invalid token");
        }
        
        // Step 2: Forward to Task Manager
        request.setUserId(authResult.getUserId());
        TaskResponse response = taskManagerClient.createTask(request);
        
        return ResponseEntity.ok(response);
    }
}
````

2. Authentication Service:

````java:enterprise-llm-system/services/auth-service/src/main/java/com/llm/auth/service/AuthenticationService.java
@Service
@Slf4j
public class AuthenticationService {

    @Autowired
    private KeycloakClient keycloakClient;
    
    @Autowired
    private TokenStore tokenStore;

    public AuthResult validateToken(String token) {
        log.info("Validating token");
        
        // Remove "Bearer " prefix if present
        String actualToken = token.replace("Bearer ", "");
        
        // Check token store first
        Optional<TokenInfo> cachedToken = tokenStore.getToken(actualToken);
        if (cachedToken.isPresent()) {
            return new AuthResult(true, cachedToken.get().getUserId());
        }
        
        // Validate with Keycloak
        TokenValidationResult result = keycloakClient.validateToken(actualToken);
        if (result.isValid()) {
            // Cache token
            tokenStore.storeToken(actualToken, new TokenInfo(result.getUserId()));
            return new AuthResult(true, result.getUserId());
        }
        
        return new AuthResult(false, null);
    }
}
````

3. Token Store Service:

````java:enterprise-llm-system/services/auth-service/src/main/java/com/llm/auth/store/TokenStore.java
@Service
public class TokenStore {

    @Autowired
    private RedisTemplate<String, TokenInfo> redisTemplate;
    
    private static final String TOKEN_PREFIX = "token:";
    private static final long TOKEN_TTL = 3600; // 1 hour

    public void storeToken(String token, TokenInfo info) {
        String key = TOKEN_PREFIX + token;
        redisTemplate.opsForValue().set(key, info, TOKEN_TTL, TimeUnit.SECONDS);
    }

    public Optional<TokenInfo> getToken(String token) {
        String key = TOKEN_PREFIX + token;
        TokenInfo info = redisTemplate.opsForValue().get(key);
        return Optional.ofNullable(info);
    }
}
````

4. Task Manager Service:

````java:enterprise-llm-system/services/task-manager/src/main/java/com/llm/taskmanager/controller/TaskController.java
@RestController
@RequestMapping("/api/tasks")
@Slf4j
public class TaskController {

    @Autowired
    private TaskService taskService;

    @PostMapping
    public ResponseEntity<TaskResponse> createTask(@RequestBody TaskRequest request) {
        log.info("Creating task for user: {}", request.getUserId());
        
        Task task = taskService.createTask(request);
        
        TaskResponse response = TaskResponse.builder()
            .taskId(task.getId())
            .status(task.getStatus())
            .createdAt(task.getCreatedAt())
            .build();
            
        return ResponseEntity.ok(response);
    }
}
````

5. Postman Collection:

````json:enterprise-llm-system/postman/Flow1-RequestInit.postman_collection.json
{
  "info": {
    "name": "LLM System - Flow 1",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Get Auth Token",
      "request": {
        "method": "POST",
        "header": [],
        "url": {
          "raw": "{{auth_url}}/realms/llm-system/protocol/openid-connect/token",
          "host": ["{{auth_url}}"],
          "path": [
            "realms",
            "llm-system",
            "protocol",
            "openid-connect",
            "token"
          ]
        },
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "grant_type",
              "value": "password"
            },
            {
              "key": "client_id",
              "value": "llm-system"
            },
            {
              "key": "username",
              "value": "{{username}}"
            },
            {
              "key": "password", 
              "value": "{{password}}"
            }
          ]
        }
      }
    },
    {
      "name": "Create Task",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{auth_token}}"
          }
        ],
        "url": {
          "raw": "{{api_url}}/api/tasks",
          "host": ["{{api_url}}"],
          "path": ["api", "tasks"]
        },
        "body": {
          "mode": "raw",
          "raw": "{\n  \"input\": \"Analyze this text using multiple LLMs\",\n  \"models\": [\"gpt-4\", \"claude-3\"],\n  \"priority\": 1\n}",
          "options": {
            "raw": {
              "language": "json"
            }
          }
        }
      }
    }
  ],
  "variable": [
    {
      "key": "auth_url",
      "value": "http://localhost:8180"
    },
    {
      "key": "api_url", 
      "value": "http://localhost:8080"
    }
  ]
}
````

6. Environment Variables:

````yaml:enterprise-llm-system/configs/env/.env
# API Gateway
API_GATEWAY_PORT=8080

# Keycloak
KEYCLOAK_URL=http://localhost:8180
KEYCLOAK_REALM=llm-system
KEYCLOAK_CLIENT_ID=llm-system
KEYCLOAK_CLIENT_SECRET=your-client-secret

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# PostgreSQL
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=llm_system
POSTGRES_USER=llm_user
POSTGRES_PASSWORD=your-password
````

Để test Flow 1:

1. Khởi động các service:
```bash
docker-compose up -d
```

2. Import collection vào Postman

3. Tạo environment với các biến:
- username: your-username
- password: your-password
- auth_token: (sẽ được set tự động sau khi get token)

4. Chạy request "Get Auth Token" để lấy token

5. Chạy request "Create Task" để test flow hoàn chỉnh

Request sẽ đi qua các bước:
1. API Gateway nhận request
2. Forward tới Auth Service để validate token
3. Auth Service check token trong Redis cache
4. Nếu không có trong cache, validate với Keycloak
5. Sau khi validate thành công, forward request tới Task Manager
6. Task Manager tạo task và trả về response

Bạn cần thêm thông tin về phần nào không?


### Lỗi này xảy ra vì Keycloak chưa được cấu hình đúng. Tôi sẽ hướng dẫn bạn cấu hình Keycloak:

1. Đầu tiên, tạo file cấu hình cho Keycloak:

````yaml:enterprise-llm-system/configs/keycloak/realm-config.json
{
  "realm": "llm-system",
  "enabled": true,
  "users": [
    {
      "username": "test-user",
      "enabled": true,
      "credentials": [
        {
          "type": "password",
          "value": "test-password",
          "temporary": false
        }
      ],
      "realmRoles": ["user"]
    }
  ],
  "roles": {
    "realm": [
      {
        "name": "user",
        "description": "User role"
      }
    ]
  },
  "clients": [
    {
      "clientId": "llm-system",
      "enabled": true,
      "publicClient": false,
      "secret": "your-client-secret",
      "redirectUris": ["*"],
      "webOrigins": ["*"],
      "protocol": "openid-connect",
      "directAccessGrantsEnabled": true
    }
  ]
}
````

2. Thêm service Keycloak vào docker-compose:

````yaml:enterprise-llm-system/docker-compose.yml
services:
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HOSTNAME: localhost
    ports:
      - "8180:8080"
    volumes:
      - ./configs/keycloak:/opt/keycloak/data/import
    command:
      - start-dev
      - --import-realm
    depends_on:
      - postgres
    networks:
      - security

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - security

networks:
  security:

volumes:
  postgres_data:
````

3. Script để khởi tạo Keycloak:

````bash:enterprise-llm-system/scripts/init-keycloak.sh
#!/bin/bash

# Wait for Keycloak to start
echo "Waiting for Keycloak to start..."
while ! curl -s http://localhost:8180/health > /dev/null; do
    sleep 5
done

# Get admin token
echo "Getting admin token..."
ADMIN_TOKEN=$(curl -X POST http://localhost:8180/realms/master/protocol/openid-connect/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'username=admin' \
  -d 'password=admin' \
  -d 'grant_type=password' \
  -d 'client_id=admin-cli' | jq -r '.access_token')

# Create realm
echo "Creating realm..."
curl -X POST http://localhost:8180/admin/realms \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d @configs/keycloak/realm-config.json

echo "Keycloak setup completed!"
````

4. Cập nhật file .env:

````env:enterprise-llm-system/configs/env/.env
# Keycloak
KEYCLOAK_URL=http://localhost:8180
KEYCLOAK_REALM=llm-system
KEYCLOAK_CLIENT_ID=llm-system
KEYCLOAK_CLIENT_SECRET=your-client-secret
KEYCLOAK_ADMIN_USERNAME=admin
KEYCLOAK_ADMIN_PASSWORD=admin

# Test User
TEST_USERNAME=test-user
TEST_PASSWORD=test-password
````

5. Khởi động hệ thống:

```bash
# Start services
docker-compose up -d

# Wait for services to start
sleep 30

# Initialize Keycloak
./scripts/init-keycloak.sh
```

6. Giờ bạn có thể test lại API với credentials:

```bash
curl --location 'http://localhost:8180/realms/llm-system/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=password' \
--data-urlencode 'client_id=llm-system' \
--data-urlencode 'username=test-user' \
--data-urlencode 'password=test-password'
```

Response sẽ trả về token:

```json
{
    "access_token": "eyJhbGciOiJSUzI1...",
    "expires_in": 300,
    "refresh_expires_in": 1800,
    "refresh_token": "eyJhbGciOiJIUzI1...",
    "token_type": "Bearer",
    "scope": "profile email"
}
```

Sau khi có token, bạn có thể sử dụng nó để gọi API tasks:

```bash
curl --location 'http://localhost:8080/api/tasks' \
--header 'Authorization: Bearer eyJhbGciOiJSUzI1...' \
--header 'Content-Type: application/json' \
--data '{
    "input": "Analyze this text using multiple LLMs",
    "models": ["gpt-4", "claude-3"],
    "priority": 1
}'
```

Bạn cần thêm thông tin gì không?


### Lỗi này xảy ra do thiếu `jq` và token không được tạo thành công. Hãy sửa lại script như sau:

1. Đầu tiên, cài đặt `jq`:

```bash
sudo apt-get update
sudo apt-get install jq
```

2. Sửa lại file init-keycloak.sh:

````bash:enterprise-llm-system/scripts/init-keycloak.sh
#!/bin/bash

# Wait for Keycloak to start
echo "Waiting for Keycloak to start..."
max_attempts=30
attempt=1

while ! curl -s http://localhost:8180/health > /dev/null; do
    if [ $attempt -gt $max_attempts ]; then
        echo "Keycloak failed to start after $max_attempts attempts"
        exit 1
    fi
    echo "Attempt $attempt: Keycloak not ready, waiting..."
    sleep 10
    attempt=$((attempt + 1))
done

echo "Keycloak is running"

# Get admin token
echo "Getting admin token..."
TOKEN_RESPONSE=$(curl -s -X POST http://localhost:8180/realms/master/protocol/openid-connect/token \
    -H 'Content-Type: application/x-www-form-urlencoded' \
    --data-urlencode "client_id=admin-cli" \
    --data-urlencode "username=admin" \
    --data-urlencode "password=admin" \
    --data-urlencode "grant_type=password")

if [ -z "$TOKEN_RESPONSE" ]; then
    echo "Failed to get token response"
    exit 1
fi

ADMIN_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')

if [ -z "$ADMIN_TOKEN" ] || [ "$ADMIN_TOKEN" = "null" ]; then
    echo "Failed to extract token from response:"
    echo $TOKEN_RESPONSE
    exit 1
fi

echo "Admin token obtained successfully"

# Create realm
echo "Creating realm..."
REALM_RESPONSE=$(curl -s -X POST http://localhost:8180/admin/realms \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -H "Content-Type: application/json" \
    -d @configs/keycloak/realm-config.json)

if [ ! -z "$REALM_RESPONSE" ]; then
    echo "Realm creation response:"
    echo $REALM_RESPONSE
fi

# Verify realm creation
echo "Verifying realm creation..."
VERIFY_RESPONSE=$(curl -s -X GET http://localhost:8180/admin/realms/llm-system \
    -H "Authorization: Bearer $ADMIN_TOKEN")

if [ -z "$VERIFY_RESPONSE" ]; then
    echo "Failed to verify realm creation"
    exit 1
fi

echo "Keycloak setup completed successfully!"
````

3. Sửa lại docker-compose.yml để thêm healthcheck:

````yaml:enterprise-llm-system/docker-compose.yml
services:
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HOSTNAME: localhost
      KC_HEALTH_ENABLED: "true"
    ports:
      - "8180:8080"
    volumes:
      - ./configs/keycloak:/opt/keycloak/data/import
    command:
      - start-dev
      - --import-realm
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - security

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - security

networks:
  security:

volumes:
  postgres_data:
````

4. Khởi động lại hệ thống:

```bash
# Stop và xóa containers cũ
docker-compose down -v

# Khởi động lại
docker-compose up -d

# Đợi một chút cho services khởi động
sleep 30

# Cấp quyền thực thi cho script
chmod +x scripts/init-keycloak.sh

# Chạy script khởi tạo
./scripts/init-keycloak.sh
```

5. Kiểm tra trạng thái:

```bash
# Kiểm tra logs
docker-compose logs keycloak

# Kiểm tra realm đã được tạo
curl http://localhost:8180/realms/llm-system/.well-known/openid-configuration
```

6. Test lại việc lấy token:

```bash
curl -X POST http://localhost:8180/realms/llm-system/protocol/openid-connect/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'grant_type=password' \
  --data-urlencode 'client_id=llm-system' \
  --data-urlencode 'username=test-user' \
  --data-urlencode 'password=test-password'
```

Nếu vẫn gặp vấn đề, bạn có thể:
1. Truy cập Keycloak Admin Console tại http://localhost:8180/admin
2. Đăng nhập với admin/admin
3. Tạo realm và user thủ công qua giao diện

Bạn cần thêm thông tin gì không?


## Lỗi này xảy ra vì client credentials không đúng. Chúng ta cần thêm client_secret vào request và đảm bảo client được cấu hình đúng.

1. Sửa lại request để thêm client_secret:

```bash
curl -X POST http://localhost:8180/realms/llm-system/protocol/openid-connect/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'grant_type=password' \
  --data-urlencode 'client_id=llm-system' \
  --data-urlencode 'client_secret=your-client-secret' \
  --data-urlencode 'username=test-user' \
  --data-urlencode 'password=test-password'
```

2. Sửa lại cấu hình realm trong file realm-config.json:

```json:enterprise-llm-system/configs/keycloak/realm-config.json
{
  "realm": "llm-system",
  "enabled": true,
  "users": [
    {
      "username": "test-user",
      "enabled": true,
      "emailVerified": true,
      "credentials": [
        {
          "type": "password",
          "value": "test-password",
          "temporary": false
        }
      ],
      "realmRoles": ["user"]
    }
  ],
  "roles": {
    "realm": [
      {
        "name": "user",
        "description": "User role"
      }
    ]
  },
  "clients": [
    {
      "clientId": "llm-system",
      "enabled": true,
      "clientAuthenticatorType": "client-secret",
      "secret": "your-client-secret",
      "redirectUris": ["*"],
      "webOrigins": ["*"],
      "publicClient": false,
      "protocol": "openid-connect",
      "directAccessGrantsEnabled": true,
      "standardFlowEnabled": true,
      "serviceAccountsEnabled": true,
      "authorizationServicesEnabled": true,
      "implicitFlowEnabled": false
    }
  ],
  "defaultRoles": ["user"]
}
```

3. Sửa lại script init-keycloak.sh để thêm bước tạo client:

```bash:enterprise-llm-system/scripts/init-keycloak.sh
#!/bin/bash

# ... (phần code cũ giữ nguyên)

# Create realm
echo "Creating realm..."
REALM_RESPONSE=$(curl -s -X POST http://localhost:8180/admin/realms \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -H "Content-Type: application/json" \
    -d @configs/keycloak/realm-config.json)

# Verify realm creation
echo "Verifying realm creation..."
VERIFY_RESPONSE=$(curl -s -X GET http://localhost:8180/admin/realms/llm-system \
    -H "Authorization: Bearer $ADMIN_TOKEN")

if [ -z "$VERIFY_RESPONSE" ]; then
    echo "Failed to verify realm creation"
    exit 1
fi

# Verify client creation
echo "Verifying client configuration..."
CLIENT_RESPONSE=$(curl -s -X GET http://localhost:8180/admin/realms/llm-system/clients \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -H "Content-Type: application/json")

if [ -z "$CLIENT_RESPONSE" ]; then
    echo "Failed to verify client configuration"
    exit 1
fi

echo "Keycloak setup completed successfully!"
```

4. Khởi động lại toàn bộ hệ thống:

```bash
# Dừng và xóa containers
docker-compose down -v

# Xóa volumes cũ
docker volume prune -f

# Khởi động lại
docker-compose up -d

# Đợi services khởi động
sleep 30

# Chạy script khởi tạo
./scripts/init-keycloak.sh
```

5. Kiểm tra cấu hình qua Keycloak Admin Console:
- Truy cập http://localhost:8180/admin
- Đăng nhập với admin/admin
- Chọn realm "llm-system"
- Kiểm tra:
  - Clients -> llm-system -> Credentials tab
  - Users -> test-user
  - Client Scopes
  - Roles

6. Test lại việc lấy token với client_secret:

```bash
export CLIENT_SECRET=your-client-secret

curl -X POST http://localhost:8180/realms/llm-system/protocol/openid-connect/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'grant_type=password' \
  --data-urlencode 'client_id=llm-system' \
  --data-urlencode "client_secret=$CLIENT_SECRET" \
  --data-urlencode 'username=test-user' \
  --data-urlencode 'password=test-password'
```

Nếu vẫn gặp lỗi, bạn có thể:
1. Kiểm tra logs: `docker-compose logs keycloak`
2. Đảm bảo client_secret trong request khớp với cấu hình trong realm
3. Thử tạo client và user mới thông qua Admin Console

Bạn cần thêm thông tin gì không?
