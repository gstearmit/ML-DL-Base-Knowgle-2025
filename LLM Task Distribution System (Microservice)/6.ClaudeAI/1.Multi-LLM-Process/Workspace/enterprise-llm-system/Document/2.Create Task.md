

Lỗi này xảy ra vì API Gateway service chưa được khởi động. Chúng ta cần thêm API Gateway service vào docker-compose.yml:

````yaml:enterprise-llm-system/docker-compose.yml
services:
  # Các services hiện tại giữ nguyên...

  api-gateway:
    image: kong:latest
    environment:
      KONG_DATABASE: "off"
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_DECLARATIVE_CONFIG: /usr/local/kong/declarative/kong.yml
    ports:
      - "8080:8000"
      - "8001:8001"
      - "8443:8443"
    volumes:
      - ./configs/kong:/usr/local/kong/declarative
    networks:
      - security

  task-manager:
    build: 
      context: ./services/task-manager
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/llm_system
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      KEYCLOAK_AUTH_SERVER_URL: http://keycloak:8080/auth
    ports:
      - "8081:8081"
    depends_on:
      - postgres
      - keycloak
    networks:
      - security

  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: docker
      KEYCLOAK_AUTH_SERVER_URL: http://keycloak:8080/auth
      REDIS_HOST: redis
    ports:
      - "8082:8082"
    depends_on:
      - keycloak
      - redis
    networks:
      - security

  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    networks:
      - security
````

Tạo file cấu hình cho Kong:

````yaml:enterprise-llm-system/configs/kong/kong.yml
_format_version: "2.1"
_transform: true

services:
  - name: task-service
    url: http://task-manager:8081
    routes:
      - name: task-routes
        paths:
          - /api/tasks
        strip_path: false
    plugins:
      - name: key-auth
        config:
          key_names:
            - apikey
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Authorization
            - Content-Type
          exposed_headers:
            - Authorization
          credentials: true
          max_age: 3600

  - name: auth-service
    url: http://auth-service:8082
    routes:
      - name: auth-routes
        paths:
          - /api/auth
        strip_path: false
````

Tạo Dockerfile cho Task Manager:

````dockerfile:enterprise-llm-system/services/task-manager/Dockerfile
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8081
ENTRYPOINT ["java","-jar","app.jar"]
````

Tạo Dockerfile cho Auth Service:

````dockerfile:enterprise-llm-system/services/auth-service/Dockerfile
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8082
ENTRYPOINT ["java","-jar","app.jar"]
````

Cập nhật file .env:

````env:enterprise-llm-system/configs/env/.env
# API Gateway
KONG_ADMIN_TOKEN=your-admin-token

# Services
TASK_MANAGER_PORT=8081
AUTH_SERVICE_PORT=8082

# Các cấu hình khác giữ nguyên...
````

Khởi động lại hệ thống:

````bash
# Build các services
cd services/task-manager
./mvnw clean package
cd ../auth-service
./mvnw clean package
cd ../..

# Khởi động lại toàn bộ hệ thống
docker-compose down -v
docker-compose up -d

# Đợi services khởi động
sleep 30

# Khởi tạo Keycloak
./scripts/init-keycloak.sh
````

Test lại API:

1. Lấy token:
````bash
curl -X POST http://localhost:8180/realms/llm-system/protocol/openid-connect/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'grant_type=password' \
  --data-urlencode 'client_id=llm-system' \
  --data-urlencode "client_secret=your-client-secret" \
  --data-urlencode 'username=test-user' \
  --data-urlencode 'password=test-password'
````

2. Gọi API tasks với token nhận được:
````bash
curl --location 'http://localhost:8080/api/tasks' \
--header 'Authorization: Bearer <token_from_previous_response>' \
--header 'Content-Type: application/json' \
--data '{
  "input": "Analyze this text using multiple LLMs",
  "models": ["gpt-4", "claude-3"],
  "priority": 1
}'
````

Bạn cần thêm thông tin gì không?


## Lỗi này xảy ra vì chưa có file JAR trong thư mục target. Chúng ta cần tạo cấu trúc Maven project và build các service trước.

1. Tạo cấu trúc Maven cho Task Manager:

````xml:enterprise-llm-system/services/task-manager/pom.xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.7.0</version>
    </parent>

    <groupId>com.llm</groupId>
    <artifactId>task-manager</artifactId>
    <version>1.0.0</version>

    <properties>
        <java.version>17</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
````

2. Tạo cấu trúc Maven cho Auth Service:

````xml:enterprise-llm-system/services/auth-service/pom.xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.7.0</version>
    </parent>

    <groupId>com.llm</groupId>
    <artifactId>auth-service</artifactId>
    <version>1.0.0</version>

    <properties>
        <java.version>17</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
````

3. Sửa lại Dockerfile để build trong container:

````dockerfile:enterprise-llm-system/services/task-manager/Dockerfile
# Build stage
FROM maven:3.8.4-openjdk-17-slim AS build
WORKDIR /app
COPY pom.xml .
COPY src src
RUN mvn clean package -DskipTests

# Run stage
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY --from=build /app/target/*.jar app.jar
EXPOSE 8081
ENTRYPOINT ["java","-jar","app.jar"]
````

````dockerfile:enterprise-llm-system/services/auth-service/Dockerfile
# Build stage
FROM maven:3.8.4-openjdk-17-slim AS build
WORKDIR /app
COPY pom.xml .
COPY src src
RUN mvn clean package -DskipTests

# Run stage
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY --from=build /app/target/*.jar app.jar
EXPOSE 8082
ENTRYPOINT ["java","-jar","app.jar"]
````

4. Tạo main class cho Task Manager:

````java:enterprise-llm-system/services/task-manager/src/main/java/com/llm/taskmanager/TaskManagerApplication.java
package com.llm.taskmanager;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class TaskManagerApplication {
    public static void main(String[] args) {
        SpringApplication.run(TaskManagerApplication.class, args);
    }
}
````

5. Tạo main class cho Auth Service:

````java:enterprise-llm-system/services/auth-service/src/main/java/com/llm/auth/AuthServiceApplication.java
package com.llm.auth;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class AuthServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(AuthServiceApplication.class, args);
    }
}
````

6. Khởi động lại hệ thống:

````bash
# Dừng containers cũ
docker-compose down

# Build và khởi động
docker-compose up --build -d
````

Cấu trúc thư mục cuối cùng sẽ như sau:

````
enterprise-llm-system/
├── services/
│   ├── task-manager/
│   │   ├── src/
│   │   │   └── main/
│   │   │       ├── java/
│   │   │       └── resources/
│   │   ├── pom.xml
│   │   └── Dockerfile
│   └── auth-service/
│       ├── src/
│       │   └── main/
│       │       ├── java/
│       │       └── resources/
│       ├── pom.xml
│       └── Dockerfile
├── configs/
│   ├── kong/
│   ├── keycloak/
│   └── env/
└── docker-compose.yml
````

Bạn cần thêm thông tin gì không?
