#### Hãy triển khai Code theo kiến trúc database đã phân tích @v2.Database Schema Design.md 

Tôi sẽ giúp bạn triển khai code theo kiến trúc database đã phân tích. Đầu tiên, tôi sẽ tổ chức lại cấu trúc project:

```python
multi_llm_system/
├── app/
│   ├── __init__.py
│   ├── main.py
│   ├── config.py
│   ├── database/
│   │   ├── __init__.py
│   │   ├── base.py
│   │   └── models/
│   │       ├── __init__.py
│   │       ├── project.py
│   │       ├── task.py
│   │       ├── account.py
│   │       ├── result.py
│   │       └── backup.py
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── project.py
│   │   ├── task.py
│   │   ├── account.py
│   │   └── result.py
│   └── services/
│       ├── __init__.py
│       ├── project_service.py
│       ├── task_service.py
│       ├── account_service.py
│       └── result_service.py
├── requirements.txt
└── README.md
```

1. Đầu tiên, cập nhật `requirements.txt`:

```text
fastapi==0.104.1
uvicorn==0.24.0
sqlalchemy==2.0.23
pydantic==2.4.2
psycopg2-binary==2.9.9
python-jose==3.3.0
passlib==1.7.4
python-multipart==0.0.6
uuid==1.30
```

2. File `config.py`:

```python
# app/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    DATABASE_URL: str = "postgresql://user:password@localhost/multi_llm_db"
    SECRET_KEY: str = "your-secret-key"
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30

settings = Settings()
```

3. File `database/base.py`:

```python
# app/database/base.py
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from ..config import settings

engine = create_engine(settings.DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

4. Models - `database/models/project.py`:

```python
# app/database/models/project.py
from sqlalchemy import Column, String, Integer, DateTime, ForeignKey, JSON, Text
from sqlalchemy.dialects.postgresql import UUID
import uuid
from datetime import datetime
from ..base import Base

class Project(Base):
    __tablename__ = "projects"

    project_id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey("accounts.user_id"), nullable=False)
    project_name = Column(String(255), nullable=False)
    project_description = Column(Text)
    api_key = Column(UUID(as_uuid=True), ForeignKey("api_keys.key_id"), nullable=False)
    status = Column(String(50), default="active")
    priority = Column(Integer, default=1)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    deadline = Column(DateTime)
    metadata = Column(JSON)
    settings = Column(JSON)

class ProjectMember(Base):
    __tablename__ = "project_members"

    member_id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    project_id = Column(UUID(as_uuid=True), ForeignKey("projects.project_id"), nullable=False)
    user_id = Column(UUID(as_uuid=True), ForeignKey("accounts.user_id"), nullable=False)
    role = Column(String(50), nullable=False)
    joined_at = Column(DateTime, default=datetime.utcnow)
    status = Column(String(20), default="active")
    permissions = Column(JSON)
```

5. Models - `database/models/task.py`:

```python
# app/database/models/task.py
from sqlalchemy import Column, String, Integer, DateTime, ForeignKey, JSON, Text, CheckConstraint
from sqlalchemy.dialects.postgresql import UUID
import uuid
from datetime import datetime
from ..base import Base

class Task(Base):
    __tablename__ = "tasks"

    task_id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    project_id = Column(UUID(as_uuid=True), ForeignKey("projects.project_id"), nullable=False)
    user_id = Column(UUID(as_uuid=True), ForeignKey("accounts.user_id"), nullable=False)
    task_type = Column(String(50), nullable=False)
    priority = Column(Integer, default=1)
    status = Column(String(50), nullable=False)
    input_data = Column(JSON, nullable=False)
    output_data = Column(JSON)
    error_message = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    started_at = Column(DateTime)
    completed_at = Column(DateTime)
    deadline = Column(DateTime)
    assigned_worker_id = Column(UUID(as_uuid=True))
    retry_count = Column(Integer, default=0)
    max_retries = Column(Integer, default=3)
    parent_task_id = Column(UUID(as_uuid=True), ForeignKey("tasks.task_id"))
    execution_order = Column(Integer)
    metadata = Column(JSON)

    __table_args__ = (
        CheckConstraint(
            status.in_([
                'pending', 'in_queue', 'processing', 'completed',
                'failed', 'cancelled', 'paused', 'retrying'
            ]),
            name='valid_status'
        ),
    )
```

6. Schemas - `schemas/project.py`:

```python
# app/schemas/project.py
from pydantic import BaseModel, UUID4
from typing import Optional, Dict, Any
from datetime import datetime

class ProjectBase(BaseModel):
    project_name: str
    project_description: Optional[str] = None
    priority: Optional[int] = 1
    deadline: Optional[datetime] = None
    metadata: Optional[Dict[str, Any]] = None
    settings: Optional[Dict[str, Any]] = None

class ProjectCreate(ProjectBase):
    pass

class ProjectResponse(ProjectBase):
    project_id: UUID4
    user_id: UUID4
    api_key: UUID4
    status: str
    created_at: datetime
    updated_at: datetime

    class Config:
        from_attributes = True
```

7. Services - `services/project_service.py`:

```python
# app/services/project_service.py
from sqlalchemy.orm import Session
from ..database.models.project import Project
from ..schemas.project import ProjectCreate
import uuid
from datetime import datetime

class ProjectService:
    @staticmethod
    async def create_project(db: Session, project: ProjectCreate, user_id: uuid.UUID):
        db_project = Project(
            user_id=user_id,
            project_name=project.project_name,
            project_description=project.project_description,
            api_key=uuid.uuid4(),  # Tạo API key mới
            priority=project.priority,
            deadline=project.deadline,
            metadata=project.metadata,
            settings=project.settings
        )
        db.add(db_project)
        db.commit()
        db.refresh(db_project)
        return db_project

    @staticmethod
    async def get_project(db: Session, project_id: uuid.UUID):
        return db.query(Project).filter(Project.project_id == project_id).first()

    @staticmethod
    async def get_user_projects(db: Session, user_id: uuid.UUID):
        return db.query(Project).filter(Project.user_id == user_id).all()

    @staticmethod
    async def update_project(db: Session, project_id: uuid.UUID, project_data: dict):
        db_project = db.query(Project).filter(Project.project_id == project_id)
        project_data["updated_at"] = datetime.utcnow()
        db_project.update(project_data)
        db.commit()
        return db_project.first()
```

8. API Endpoints - `main.py`:

```python
# app/main.py
from fastapi import FastAPI, Depends, HTTPException
from sqlalchemy.orm import Session
from .database.base import get_db
from .services.project_service import ProjectService
from .schemas.project import ProjectCreate, ProjectResponse
import uuid

app = FastAPI(title="Multi-LLM Processing System")

@app.post("/projects/", response_model=ProjectResponse)
async def create_project(
    project: ProjectCreate,
    db: Session = Depends(get_db),
    current_user_id: uuid.UUID = None  # Thay bằng auth dependency thực tế
):
    return await ProjectService.create_project(db, project, current_user_id)

@app.get("/projects/{project_id}", response_model=ProjectResponse)
async def get_project(
    project_id: uuid.UUID,
    db: Session = Depends(get_db)
):
    project = await ProjectService.get_project(db, project_id)
    if not project:
        raise HTTPException(status_code=404, detail="Project not found")
    return project

@app.get("/projects/", response_model=list[ProjectResponse])
async def get_user_projects(
    db: Session = Depends(get_db),
    current_user_id: uuid.UUID = None  # Thay bằng auth dependency thực tế
):
    return await ProjectService.get_user_projects(db, current_user_id)
```

9. Để sử dụng qua Postman:

```http
### Tạo Project mới
POST http://localhost:8000/projects/
Content-Type: application/json

{
    "project_name": "Test Project",
    "project_description": "This is a test project",
    "priority": 1,
    "deadline": "2024-12-31T23:59:59Z",
    "metadata": {
        "client": "Test Client",
        "department": "R&D"
    },
    "settings": {
        "max_tokens": 1000,
        "temperature": 0.7
    }
}

### Lấy thông tin Project
GET http://localhost:8000/projects/{{project_id}}

### Lấy danh sách Project của user
GET http://localhost:8000/projects/
```

Đây là phần triển khai cơ bản theo schema database. Bạn cần tôi triển khai thêm phần nào không? Ví dụ như:
1. Task Management Service
2. Account Management Service
3. Result Processing Service
4. Authentication & Authorization
5. Rate Limiting & Quota Management
