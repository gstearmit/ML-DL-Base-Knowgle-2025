### lấy ví dụ Chi tiết về cấu trúc lưu trữ vector trong Weaviate, Pinecone được sử dụng để lưu trữ các tệp gốc, tệp đã xử lý, và kết quả trực quan hóa. lấy ví dụ chi tiết trong PostgreSQL về Bảng documents , document_chunks , visualizations và queries


# 1. Cấu Trúc Lưu Trữ Vector trong Pinecone và Weaviate

## Pinecone

Pinecone là vector database được tối ưu hóa cho việc lưu trữ và tìm kiếm embeddings của văn bản. Dưới đây là ví dụ chi tiết về cấu trúc lưu trữ vector:

### Cấu Trúc Vector trong Pinecone

```json
{
  "id": "doc_7ae92f3b_chunk_15",
  "values": [0.12, -0.28, 0.31, 0.02, 0.41, -0.17, ..., 0.23],
  "sparse_values": {
    "indices": [18, 57, 102, 145, 211, 287, 412, 596, 721, 903],
    "values": [0.11, 0.22, 0.19, 0.35, 0.12, 0.27, 0.14, 0.31, 0.22, 0.18]
  },
  "metadata": {
    "document_id": "7ae92f3b-9c56-4e7a-8138-972bfd87f9a2",
    "chunk_index": 15,
    "content_preview": "The architecture diagram shows the interaction between the microservices and database layer...",
    "page_number": 23,
    "section_title": "System Architecture",
    "document_type": "technical_specification",
    "project_name": "FinTech Payment Gateway",
    "creation_date": "2024-01-15T09:32:47Z",
    "last_updated": "2024-02-20T14:28:12Z",
    "tags": ["architecture", "microservices", "database", "security"],
    "token_count": 512,
    "importance_score": 0.87,
    "contains_diagrams": true,
    "referenced_components": ["API Gateway", "Auth Service", "Transaction Service", "Database Layer"],
    "file_extension": "pdf",
    "language": "en",
    "author_id": "user_42891"
  }
}
```

### Tổ Chức Namespaces và Indexes trong Pinecone

Pinecone tổ chức dữ liệu theo indexes và namespaces:

```python
# Thiết lập index trong Pinecone
index_config = {
    "name": "documentai",                   # Tên của index
    "dimension": 1536,                      # Kích thước của embedding vectors (phụ thuộc vào mô hình, OpenAI ada-002 = 1536)
    "metric": "cosine",                     # Phương pháp đo khoảng cách (cosine, euclidean, dotproduct)
    "pods": 2,                              # Số lượng pod để phân phối dữ liệu
    "pod_type": "p2.x2",                    # Loại pod quyết định hiệu suất và chi phí
    "replicas": 2,                          # Số lượng bản sao để đảm bảo tính sẵn sàng cao
    "metadata_config": {
        "indexed": ["document_type", "project_name", "tags", "language", "author_id"]  # Metadata fields để lọc
    }
}

# Sử dụng namespaces để phân tách dữ liệu
namespaces = {
    "technical_docs": "Tài liệu kỹ thuật như thiết kế hệ thống, kiến trúc",
    "requirements": "Tài liệu yêu cầu, BRD, đặc tả",
    "api_specs": "Tài liệu đặc tả API, OpenAPI specs",
    "user_guides": "Tài liệu hướng dẫn người dùng"
}

# Ví dụ upsert vector trong namespace cụ thể
pinecone_index.upsert(
    vectors=[vector_data],
    namespace="technical_docs"
)

# Ví dụ tìm kiếm trong một namespace
results = pinecone_index.query(
    vector=query_embedding,
    top_k=5,
    namespace="technical_docs",
    filter={
        "document_type": "architecture",
        "tags": {"$in": ["microservices", "database"]}
    }
)
```

## Weaviate

Weaviate là vector database theo mô hình graph, tổ chức dữ liệu theo schema với class và property:

### Cấu Trúc Schema trong Weaviate

```json
{
  "classes": [
    {
      "class": "DocumentChunk",
      "description": "A chunk of a document with vector embedding",
      "vectorizer": "none",
      "properties": [
        {
          "name": "content",
          "dataType": ["text"],
          "description": "The actual content of the document chunk"
        },
        {
          "name": "documentId",
          "dataType": ["string"],
          "description": "Reference to parent document",
          "indexInverted": true
        },
        {
          "name": "chunkIndex",
          "dataType": ["int"],
          "description": "Position of chunk within document",
          "indexInverted": true
        },
        {
          "name": "pageNumber",
          "dataType": ["int"],
          "description": "Page number in original document",
          "indexInverted": true
        },
        {
          "name": "sectionTitle",
          "dataType": ["string"],
          "description": "Title of section containing this chunk",
          "indexInverted": true
        },
        {
          "name": "documentType",
          "dataType": ["string"],
          "description": "Type of document (architecture, requirements, etc)",
          "indexInverted": true
        },
        {
          "name": "tokenCount",
          "dataType": ["int"],
          "description": "Number of tokens in chunk",
          "indexInverted": true
        },
        {
          "name": "containsDiagrams",
          "dataType": ["boolean"],
          "description": "Indicates if chunk contains diagrams",
          "indexInverted": true
        },
        {
          "name": "tags",
          "dataType": ["string[]"],
          "description": "Tags for categorization",
          "indexInverted": true
        },
        {
          "name": "createdAt",
          "dataType": ["date"],
          "description": "Creation timestamp",
          "indexInverted": true
        },
        {
          "name": "language",
          "dataType": ["string"],
          "description": "Language of content",
          "indexInverted": true
        },
        {
          "name": "belongsTo",
          "dataType": ["Document"],
          "description": "Cross-reference to Document class"
        }
      ]
    },
    {
      "class": "Document",
      "description": "Original document metadata",
      "vectorizer": "none",
      "properties": [
        {
          "name": "title",
          "dataType": ["string"],
          "description": "Title of document",
          "indexInverted": true
        },
        {
          "name": "fileName",
          "dataType": ["string"],
          "description": "Original filename",
          "indexInverted": true
        },
        {
          "name": "filePath",
          "dataType": ["string"],
          "description": "Path to file in storage",
          "indexInverted": true
        },
        {
          "name": "documentType",
          "dataType": ["string"],
          "description": "Document type/category",
          "indexInverted": true
        },
        {
          "name": "userId",
          "dataType": ["string"],
          "description": "Owner of document",
          "indexInverted": true
        },
        {
          "name": "projectName",
          "dataType": ["string"],
          "description": "Associated project",
          "indexInverted": true
        },
        {
          "name": "hasChunks",
          "dataType": ["DocumentChunk"],
          "description": "Cross-reference to DocumentChunk class"
        }
      ]
    }
  ]
}
```

### Ví Dụ Dữ Liệu Cụ Thể trong Weaviate

```json
{
  "id": "36e52158-xxxx-xxxx-xxxx-c42661d5ad36",
  "class": "DocumentChunk",
  "properties": {
    "content": "The system architecture follows a microservice pattern with three main layers: client-facing API gateway, business logic services, and data storage. Each microservice communicates via REST APIs and message queues. The database layer consists of PostgreSQL for structured data, Redis for caching, and a Vector Database for semantic search capabilities...",
    "documentId": "7ae92f3b-9c56-4e7a-8138-972bfd87f9a2",
    "chunkIndex": 15,
    "pageNumber": 23,
    "sectionTitle": "System Architecture",
    "documentType": "technical_specification",
    "tokenCount": 512,
    "containsDiagrams": true,
    "tags": ["architecture", "microservices", "database", "security"],
    "createdAt": "2024-01-15T09:32:47Z",
    "language": "en",
    "belongsTo": {
      "beacon": "weaviate://localhost/Document/9fa12b3d-xxxx-xxxx-xxxx-5f97e4d37812"
    }
  },
  "vector": [0.12, -0.28, 0.31, 0.02, 0.41, -0.17, ..., 0.23]
}
```

### Truy Vấn Vector trong Weaviate

```python
# Ví dụ truy vấn trong Weaviate (GraphQL)
query = """
{
  Get {
    DocumentChunk(
      nearVector: {
        vector: [0.12, -0.28, 0.31, 0.02, 0.41, -0.17, ..., 0.23]
        distance: 0.75
      }
      where: {
        path: ["documentType"]
        operator: Equal
        valueString: "technical_specification"
        operator: Or
        path: ["tags"]
        operator: ContainsAny
        valueStringArray: ["architecture", "database"]
      }
      limit: 5
    ) {
      content
      documentId
      pageNumber
      sectionTitle
      tokenCount
      tags
      belongsTo {
        ... on Document {
          title
          fileName
          projectName
        }
      }
      _additional {
        distance
      }
    }
  }
}
"""

# Thực thi truy vấn
result = client.query.raw(query)
```

# 2. Ví Dụ Chi Tiết Các Bảng PostgreSQL

## Bảng `documents`

```sql
-- DDL (Data Definition Language) cho bảng documents
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    filename VARCHAR(255) NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    document_type VARCHAR(100),
    mime_type VARCHAR(100) NOT NULL,
    file_path VARCHAR(512) NOT NULL,
    file_size BIGINT,
    page_count INTEGER,
    status VARCHAR(50) DEFAULT 'uploaded',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP WITH TIME ZONE,
    summary TEXT,
    importance_score DECIMAL(3,2),
    metadata JSONB,
    tags TEXT[],
    is_deleted BOOLEAN DEFAULT FALSE,
    is_public BOOLEAN DEFAULT FALSE,
    version INTEGER DEFAULT 1,
    parent_id UUID REFERENCES documents(id) ON DELETE SET NULL,
    project_id UUID REFERENCES projects(id) ON DELETE SET NULL,
    
    CONSTRAINT valid_status CHECK (status IN ('uploaded', 'processing', 'processed', 'failed', 'archived'))
);

-- Indexes để tối ưu truy vấn
CREATE INDEX idx_documents_user_id ON documents(user_id);
CREATE INDEX idx_documents_status ON documents(status);
CREATE INDEX idx_documents_created_at ON documents(created_at);
CREATE INDEX idx_documents_document_type ON documents(document_type);
CREATE INDEX idx_documents_tags ON documents USING GIN(tags);
CREATE INDEX idx_documents_metadata ON documents USING GIN(metadata jsonb_path_ops);
CREATE INDEX idx_documents_project_id ON documents(project_id) WHERE project_id IS NOT NULL;
```

### Ví Dụ Dữ Liệu trong Bảng `documents`

```sql
-- INSERT dữ liệu mẫu vào bảng documents
INSERT INTO documents (
    id, user_id, filename, original_filename, document_type, mime_type, 
    file_path, file_size, page_count, status, created_at, processed_at, 
    summary, importance_score, metadata, tags, is_public, version
) VALUES (
    '7ae92f3b-9c56-4e7a-8138-972bfd87f9a2',
    '45d9f08c-a37e-4b9c-8c55-89e7f8ea4273',
    '7ae92f3b-9c56-4e7a-8138-972bfd87f9a2.pdf',
    'FinTech_Payment_Gateway_Architecture.pdf',
    'technical_specification',
    'application/pdf',
    's3://documentai-bucket/raw-documents/45d9f08c-a37e-4b9c-8c55-89e7f8ea4273/7ae92f3b-9c56-4e7a-8138-972bfd87f9a2.pdf',
    2458631,
    42,
    'processed',
    '2024-01-15 09:32:47+00',
    '2024-01-15 09:35:12+00',
    'This document describes the architecture of the FinTech Payment Gateway system. It details a microservice-based approach with an API Gateway frontend, multiple business logic services, and a multi-layer database strategy. The document includes security considerations, high availability design, and scaling strategies. Key components include authentication, transaction processing, reporting, and monitoring subsystems.',
    0.87,
    '{
        "author": "Jane Smith",
        "department": "Engineering",
        "version_history": [
            {"version": 1, "date": "2024-01-10", "author": "Jane Smith", "notes": "Initial draft"},
            {"version": 2, "date": "2024-01-15", "author": "Jane Smith", "notes": "Final version"}
        ],
        "related_documents": ["req-spec-123", "security-spec-456"],
        "approvers": ["john.doe@company.com", "alice.wong@company.com"],
        "approval_status": "approved",
        "system_components": ["API Gateway", "Auth Service", "Transaction Service", "Reporting Service", "Database Layer"],
        "technology_stack": ["Java", "Spring Boot", "PostgreSQL", "Redis", "Kafka", "Docker", "Kubernetes"]
    }',
    ARRAY['architecture', 'microservices', 'database', 'security', 'payment', 'fintech'],
    false,
    2
);

INSERT INTO documents (
    id, user_id, filename, original_filename, document_type, mime_type, 
    file_path, file_size, page_count, status, created_at, 
    summary, metadata, tags
) VALUES (
    'c5e89d22-7a1d-4bf3-9c38-517b45e1d8b6',
    '45d9f08c-a37e-4b9c-8c55-89e7f8ea4273',
    'c5e89d22-7a1d-4bf3-9c38-517b45e1d8b6.docx',
    'User_Requirements_Specification.docx',
    'requirements',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    's3://documentai-bucket/raw-documents/45d9f08c-a37e-4b9c-8c55-89e7f8ea4273/c5e89d22-7a1d-4bf3-9c38-517b45e1d8b6.docx',
    1245782,
    28,
    'processing',
    '2024-03-02 14:27:31+00',
    null,
    '{
        "author": "Robert Johnson",
        "department": "Product Management",
        "priority": "high",
        "stakeholders": ["Finance", "Customer Support", "Compliance"],
        "project_phase": "planning",
        "estimated_completion": "2024-06-30"
    }',
    ARRAY['requirements', 'user-stories', 'functional', 'non-functional']
);
```

## Bảng `document_chunks`

```sql
-- DDL (Data Definition Language) cho bảng document_chunks
CREATE TABLE document_chunks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
    chunk_index INTEGER NOT NULL,
    content TEXT NOT NULL,
    content_hash VARCHAR(64),
    token_count INTEGER,
    embedding_id VARCHAR(255),
    embedding_model VARCHAR(100),
    page_number INTEGER,
    section_title TEXT,
    section_level INTEGER,
    contains_code BOOLEAN DEFAULT FALSE,
    contains_table BOOLEAN DEFAULT FALSE,
    contains_image BOOLEAN DEFAULT FALSE,
    metadata JSONB,
    importance_score DECIMAL(3,2),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(document_id, chunk_index)
);

-- Indexes để tối ưu truy vấn
CREATE INDEX idx_document_chunks_document_id ON document_chunks(document_id);
CREATE INDEX idx_document_chunks_embedding_id ON document_chunks(embedding_id);
CREATE INDEX idx_document_chunks_content_hash ON document_chunks(content_hash);
CREATE INDEX idx_document_chunks_full_text ON document_chunks USING GIN (to_tsvector('english', content));
CREATE INDEX idx_document_chunks_metadata ON document_chunks USING GIN(metadata jsonb_path_ops);
CREATE INDEX idx_document_chunks_importance ON document_chunks(importance_score DESC);
```

### Ví Dụ Dữ Liệu trong Bảng `document_chunks`

```sql
-- INSERT dữ liệu mẫu vào bảng document_chunks
INSERT INTO document_chunks (
    id, document_id, chunk_index, content, content_hash, token_count, 
    embedding_id, embedding_model, page_number, section_title, section_level,
    contains_code, contains_table, contains_image, metadata, importance_score
) VALUES (
    '5d183b64-e748-42a7-95c1-3f8e4c6d41fa',
    '7ae92f3b-9c56-4e7a-8138-972bfd87f9a2',
    15,
    'The system architecture follows a microservice pattern with three main layers: client-facing API gateway, business logic services, and data storage. Each microservice communicates via REST APIs and message queues. The database layer consists of PostgreSQL for structured data, Redis for caching, and a Vector Database for semantic search capabilities. Security is implemented at multiple levels, with the API Gateway handling authentication via OAuth 2.0 and JWT tokens, while individual services implement authorization checks based on user roles and permissions. High availability is achieved through containerization with Docker and orchestration via Kubernetes, allowing horizontal scaling of services based on demand.',
    'sha256:a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2',
    512,
    'doc_7ae92f3b_chunk_15',
    'text-embedding-ada-002',
    23,
    'System Architecture',
    1,
    false,
    false,
    true,
    '{
        "technical_terms": ["microservice", "API gateway", "REST API", "PostgreSQL", "Redis", "OAuth 2.0", "JWT", "Docker", "Kubernetes"],
        "key_components": ["API Gateway", "Auth Service", "Transaction Service", "Database Layer"],
        "image_captions": ["High-level Architecture Diagram"],
        "paragraph_type": "descriptive",
        "references": [
            {"doc_id": "89de42a1-cccc-dddd-eeee-12345abcdef", "section": "Database Design"}
        ]
    }',
    0.92
);

INSERT INTO document_chunks (
    id, document_id, chunk_index, content, content_hash, token_count, 
    embedding_id, embedding_model, page_number, section_title, section_level,
    contains_code, contains_table, contains_image, metadata, importance_score
) VALUES (
    '723af519-88bb-4ea1-b935-9cdd2f88dc05',
    '7ae92f3b-9c56-4e7a-8138-972bfd87f9a2',
    16,
    'The Transaction Service is the core component of the payment gateway system. It handles payment processing, validation, and communication with external payment providers. This service must maintain ACID properties for all transactions and implement idempotency to prevent duplicate payments. The service architecture includes the following sub-components:\n\n1. Transaction Manager: Coordinates the overall payment flow\n2. Payment Provider Adaptors: Interfaces with various payment processors\n3. Risk Assessment Engine: Evaluates transaction risk in real-time\n4. Transaction Logger: Maintains detailed audit logs\n\nAll transactions are persisted in PostgreSQL with a specific schema designed for financial data integrity and auditability.',
    'sha256:b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3',
    498,
    'doc_7ae92f3b_chunk_16',
    'text-embedding-ada-002',
    24,
    'Transaction Service',
    2,
    false,
    true,
    false,
    '{
        "technical_terms": ["ACID", "idempotency", "Transaction Manager", "Payment Provider Adaptors", "Risk Assessment Engine"],
        "key_components": ["Transaction Service", "Transaction Manager", "Payment Provider Adaptors"],
        "paragraph_type": "component-description",
        "contains_numbered_list": true
    }',
    0.88
);
```

## Bảng `visualizations`

```sql
-- DDL (Data Definition Language) cho bảng visualizations
CREATE TABLE visualizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    visualization_type VARCHAR(100) NOT NULL,
    file_path VARCHAR(512) NOT NULL,
    thumbnail_path VARCHAR(512),
    format VARCHAR(20) NOT NULL,
    width INTEGER,
    height INTEGER,
    parameters JSONB,
    source_content TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    generated_by VARCHAR(100) DEFAULT 'ai',
    is_deleted BOOLEAN DEFAULT FALSE,
    is_public BOOLEAN DEFAULT FALSE,
    version INTEGER DEFAULT 1,
    parent_id UUID REFERENCES visualizations(id) ON DELETE SET NULL,
    tags TEXT[],
    
    CONSTRAINT valid_type CHECK (visualization_type IN ('sequence_diagram', 'flowchart', 'erd', 'architecture', 'gantt', 'class_diagram', 'network_diagram', 'mindmap'))
);

-- Indexes
CREATE INDEX idx_visualizations_document_id ON visualizations(document_id);
CREATE INDEX idx_visualizations_user_id ON visualizations(user_id);
CREATE INDEX idx_visualizations_type ON visualizations(visualization_type);
CREATE INDEX idx_visualizations_created_at ON visualizations(created_at);
CREATE INDEX idx_visualizations_tags ON visualizations USING GIN(tags);
```

### Ví Dụ Dữ Liệu trong Bảng `visualizations`

```sql
-- INSERT dữ liệu mẫu vào bảng visualizations
INSERT INTO visualizations (
    id, document_id, user_id, title, description, visualization_type,
    file_path, thumbnail_path, format, width, height, parameters,
    source_content, created_at, tags
) VALUES (
    'e95d2317-6cd4-45e6-a59c-39c3ec3c6741',
    '7ae92f3b-9c56-4e7a-8138-972bfd87f9a2',
    '45d9f08c-a37e-4b9c-8c55-89e7f8ea4273',
    'Payment Gateway Architecture Diagram',
    'High-level architecture diagram showing the main components of the FinTech Payment Gateway system',
    'architecture',
    's3://documentai-bucket/visualizations/45d9f08c-a37e-4b9c-8c55-89e7f8ea4273/e95d2317-6cd4-45e6-a59c-39c3ec3c6741.svg',
    's3://documentai-bucket/visualizations/45d9f08c-a37e-4b9c-8c55-89e7f8ea4273/e95d2317-6cd4-45e6-a59c-39c3ec3c6741_thumb.png',
    'svg',
    1200,
    800,
    '{
        "theme": "blue",
        "showLegend": true,
        "groupByLayer": true,
        "includeLabels": true,
        "layoutAlgorithm": "hierarchical"
    }',
    'graph TB\n  subgraph Client["Client Layer"]\n    Web["Web Application"]\n    Mobile["Mobile App"]\n    ThirdParty["3rd Party Systems"]\n  end\n  subgraph Gateway["API Gateway"]\n    Auth["Authentication"]\n    Routing["Request Routing"]\n    Logging["API Logging"]\n  end\n  subgraph Services["Microservices"]\n    AuthService["Auth Service"]\n    TransactionService["Transaction Service"]\n    ReportingService["Reporting Service"]\n    NotificationService["Notification Service"]\n  end\n  subgraph Data["Database Layer"]\n    SQL[(PostgreSQL)]\n    Cache[(Redis)]\n    EventStore[(Kafka)]\n  end\n  Client --> Gateway\n  Gateway --> Services\n  Services --> Data',
    '2024-01-17 11:23:45+00',
    ARRAY['architecture', 'system-design', 'payment-gateway', 'microservices']
);

INSERT INTO visualizations (
    id, document_id, user_id, title, description, visualization_type,
    file_path, thumbnail_path, format, width, height, parameters,
    source_content, created_at, tags
) VALUES (
    'f72c4b81-d9ef-4a12-b5e9-078e4ce3d159',
    '7ae92f3b-9c56-4e7a-8138-972bfd87f9a2',
    '45d9f08c-a37e-4b9c-8c55-89e7f8ea4273',
    'Payment Transaction Flow Sequence Diagram',
    'Detailed sequence diagram showing the flow of a payment transaction through the system',
    'sequence_diagram',
    's3://documentai-bucket/visualizations/45d9f08c-a37e-4b9c-8c55-89e7f8ea4273/f72c4b81-d9ef-4a12-b5e9-078e4ce3d159.svg',
    's3://documentai-bucket/visualizations/45d9f08c-a37e-4b9c-8c55-89e7f8ea4273/f72c4b81-d9ef-4a12-b5e9-078e4ce3d159_thumb.png',
    'svg',
    1500,
    1200,
    '{
        "theme": "simple",
        "showNotes": true,
        "includeActivation": true,
        "showTimeline": false
    }',
    'sequenceDiagram\n  participant C as Client\n  participant G as API Gateway\n  participant A as Auth Service\n  participant T as Transaction Service\n  participant P as Payment Provider\n  participant D as Database\n  C->>G: Submit Payment\n  G->>A: Validate Token\n  A->>G: Token Valid\n  G->>T: Process Payment\n  T->>T: Validate Request\n  T->>D: Begin Transaction\n  T->>P: Submit to Provider\n  P->>T: Payment Approved\n  T->>D: Update Transaction\n  T->>G: Return Result\n  G->>C: Payment Confirmation',
    '2024-01-18 09:42:17+00',
    ARRAY['sequence-diagram', 'payment-flow', 'transaction-processing']
);
```

## Bảng `queries`

```sql
-- DDL (Data Definition Language) cho bảng queries
CREATE TABLE queries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    session_id UUID,
    query_text TEXT NOT NULL,
    query_embedding VECTOR(1536),
    response_text TEXT,
    document_ids UUID[] NOT NULL,
    context_chunks UUID[],
    source_chunks JSONB,
    execution_time_ms INTEGER,
    token_usage JSONB,
    similarity_score DECIMAL(5,4),
    feedback_rating INTEGER,
    feedback_text TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    query_type VARCHAR(50) DEFAULT 'rag',
    metadata JSONB,
    tags TEXT[],
    project_id UUID REFERENCES projects(id) ON DELETE SET NULL,
    
    CONSTRAINT valid_rating CHECK (feedback_rating IS NULL OR (feedback_rating >= 1 AND feedback_rating <= 5)),
    CONSTRAINT valid_query_type CHECK (query_type IN ('rag', 'direct', 'hybrid', 'summary', 'classification'))
);

-- Indexes
CREATE INDEX idx_queries_user_id ON queries(user_id);
CREATE INDEX idx_queries_session_id ON queries(session_id);
CREATE INDEX idx_queries_created_at ON queries(created_at);
CREATE INDEX idx_queries_document_ids ON queries USING GIN(document_ids);
CREATE INDEX idx_queries_context_chunks ON queries USING GIN(context_chunks);
CREATE INDEX idx_queries_embedding ON queries USING ivfflat (query_embedding vector_cosine_ops);
CREATE INDEX idx_queries_tags ON queries USING GIN(tags);
CREATE INDEX idx_queries_full_text ON queries USING GIN (to_tsvector('english', query_text));
```

### Ví Dụ Dữ Liệu trong Bảng `queries`

```sql
-- INSERT dữ liệu mẫu vào bảng queries
INSERT INTO queries (
    id, user_id, session_id, query_text, 
    response_text, document_ids, context_chunks,
    source_chunks, execution_time_ms, token_usage,
    similarity_score, feedback_rating, created_at, query_type, metadata
) VALUES (
    '21f5a692-837e-4e19-bb7c-f8df22f47c3a',
    '45d9f08c-a37e-4b9c-8c55-89e7f8ea4273',
    '95c6a8d7-e432-49b3-b8f1-2e9dbc7c6e8b',
    'How does the payment transaction flow work?',
    'The payment transaction flow in the FinTech Payment Gateway system follows these steps:\n\n1. The client application submits payment details to the API Gateway\n2. The API Gateway validates the authentication token with the Auth Service\n3. Once validated, the request is routed to the Transaction Service\n4. The Transaction Service validates the request format and parameters\n5. The Transaction Service begins a database transaction to ensure ACID properties\n6. The payment request is submitted to the appropriate Payment Provider\n7. Upon receiving approval from the Payment Provider, the transaction is updated in the database\n8. The Transaction Service returns the result to the API Gateway, which forwards confirmation to the client\n\nThis flow ensures security through authentication, data integrity through database transactions, and reliable processing through the dedicated Transaction Service. The system also implements idempotency to prevent duplicate payments and maintains detailed audit logs for compliance purposes.',
    ARRAY['7ae92f3b-9c56-4e7a-8138-972bfd87f9a2'],
    ARRAY['5d183b64-e748-42a7-95c1-3f8e4c6d41fa', '723af519-88bb-4ea1-b935-9cdd2f88dc05'],
    '[
        {
            "chunk_id": "723af519-88bb-4ea1-b935-9cdd2f88dc05",
            "document_id": "7ae92f3b-9c56-4e7a-8138-972bfd87f9a2",
            "content": "The Transaction Service is the core component of the payment gateway system...",
            "similarity": 0.932,
            "page_number": 24,
            "section_title": "Transaction Service"
        },
        {
            "chunk_id": "5d183b64-e748-42a7-95c1-3f8e4c6d41fa",
            "document_id": "7ae92f3b-9c56-4e7a-8138-972bfd87f9a2",
            "content": "The system architecture follows a microservice pattern with three main layers...",
            "similarity": 0.857,
            "page_number": 23,
            "section_title": "System Architecture"
        }
    ]',
    642,
    '{
        "prompt_tokens": 2134,
        "completion_tokens": 248,
        "total_tokens": 2382
    }',
    0.932,
    5,
    '2024-03-02 16:42:13+00',
    'rag',
    '{
        "llm_model": "gpt-4",
        "embedding_model": "text-embedding-ada-002",
        "device": "web",
        "browser": "chrome",
        "ip_city": "San Francisco",
        "top_k": 5,
        "temperature": 0.2,
        "search_approach": "hybrid"
    }'
);

INSERT INTO queries (
    id, user_id, session_id, query_text, 
    response_text, document_ids, context_chunks,
    source_chunks, execution_time_ms, token_usage,
    similarity_score, feedback_rating, feedback_text,
    created_at, query_type, metadata
) VALUES (
    'a7c51b89-fc2e-47d4-9a6e-3bd8ef7dcd2b',
    '45d9f08c-a37e-4b9c-8c55-89e7f8ea4273',
    '95c6a8d7-e432-49b3-b8f1-2e9dbc7c6e8b',
    'What security measures are implemented in the system?',
    'The FinTech Payment Gateway system implements multiple layers of security:\n\n1. Authentication via OAuth 2.0 and JWT tokens at the API Gateway level\n2. Role-based authorization checks in individual microservices\n3. Encrypted communication using TLS/SSL for all service interactions\n4. Secure storage of sensitive payment information following PCI-DSS guidelines\n5. Real-time risk assessment for fraud detection during transactions\n6. Comprehensive audit logging for all system activities\n7. Data encryption at rest in the PostgreSQL database\n8. Rate limiting to prevent denial-of-service attacks\n\nThe security architecture follows defense-in-depth principles, ensuring that multiple security controls must be compromised for a breach to occur.',
    ARRAY['7ae92f3b-9c56-4e7a-8138-972bfd87f9a2'],
    ARRAY['5d183b64-e748-42a7-95c1-3f8e4c6d41fa', '9a4b2e18-7c5d-4f3e-a1b2-c3d4e5f6a7b8'],
    '[
        {
            "chunk_id": "5d183b64-e748-42a7-95c1-3f8e4c6d41fa",
            "document_id": "7ae92f3b-9c56-4e7a-8138-972bfd87f9a2",
            "content": "The system architecture follows a microservice pattern with three main layers...",
            "similarity": 0.892,
            "page_number": 23,
            "section_title": "System Architecture"
        },
        {
            "chunk_id": "9a4b2e18-7c5d-4f3e-a1b2-c3d4e5f6a7b8",
            "document_id": "7ae92f3b-9c56-4e7a-8138-972bfd87f9a2",
            "content": "Security is a primary concern for the payment gateway...",
            "similarity": 0.937,
            "page_number": 28,
            "section_title": "Security Architecture"
        }
    ]',
    578,
    '{
        "prompt_tokens": 1876,
        "completion_tokens": 232,
        "total_tokens": 2108
    }',
    0.937,
    4,
    'Response was accurate but could include more details about encryption standards',
    '2024-03-02 16:45:27+00',
    'rag',
    '{
        "llm_model": "gpt-4",
        "embedding_model": "text-embedding-ada-002",
        "device": "web",
        "browser": "chrome",
        "ip_city": "San Francisco",
        "top_k": 5,
        "temperature": 0.2,
        "search_approach": "hybrid"
    }'
);
```

This completes the detailed examples for the `queries` table in PostgreSQL. These examples demonstrate the structure and relationships of the data stored in this table, including query text, response text, relevant document and chunk references, performance metrics, and user feedback. The table is designed to support comprehensive tracking of user interactions with the system for analytics, improvement, and auditing purposes.